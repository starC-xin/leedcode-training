package high;

import utils.Common;

import java.util.ArrayList;
import java.util.Comparator;
import java.util.List;
import java.util.PriorityQueue;

/**
 * 2023/5/28
 * 1439. 有序矩阵中的第 k 个最小数组和
 * 给你一个 m * n 的矩阵 mat，以及一个整数 k ，矩阵中的每一行都以非递减的顺序排列。
 *
 * 你可以从每一行中选出 1 个元素形成一个数组。返回所有可能数组中的第 k 个 最小 数组和。
 *
 * @author x.z
 */
public class Solution1439 {

    /**
     * TODO 先暴力循环
     */
    public int kthSmallest(int[][] mat, int k) {
        final PriorityQueue<Integer> pq = new PriorityQueue<>(Comparator.reverseOrder());
        final PriorityQueue<int[]> matPq = new PriorityQueue<>((a, b) -> b[0] - a[0]);
        for (int[] line : mat) {
            matPq.offer(line);
        }
        List<int[]> matList= new ArrayList<>();
        while(!matPq.isEmpty()){
            matList.add(matPq.poll());
        }
        sub(k, 0, pq, matList, 0);
        return pq.poll();
    }

    private void sub(int k, int curSum, PriorityQueue<Integer> pq, List<int[]> matList, int row){
//        出口
        if(matList.size() == row){
            if(pq.size() >= k){
                if(pq.peek() > curSum){
                    pq.poll();
                    pq.offer(curSum);
                }
            }else{
                pq.offer(curSum);
            }
            return;
        }
//        递归逻辑
        for (int num : matList.get(row)) {
//            剪枝
            if(pq.size() >= k && curSum + num >= pq.peek()){
                continue;
            }
            sub(k, curSum + num, pq, matList, row + 1);
        }
    }

    /**
     * 看了官方题解后，采用类似归并的方式，逐行求出前 k 项
     * TODO 过了，18ms，但是只超过了 35%的选手，恐怖如斯
     */
    public int kthSmallest1(int[][] mat, int k) {
        int[] lineOne = mat[0];
        for (int i = 1; i < mat.length; i++) {
            lineOne = sub(k, lineOne, mat[i]);
        }
        return lineOne[k - 1];
    }

    private int[] sub(int k, int[] lineOne, int[] lineTwo) {
        final PriorityQueue<Integer> pq = new PriorityQueue<>(Comparator.reverseOrder());

//        two在外部，one在内部可以加速整个过程
//        因为one总是前面行的前k小，有较高的概率导致其任意值小于 peek
//        但two则是独立行，有较高的概率使其值大于peek，
//        就算two全部小于peek，那下次一定可以加速，因为这会加速缩小 pq 中数值的大小，使后续过程更快跳出
//        除非原 mat 矩阵的行也是按照递减的顺序来排序的
//        这一点后续依然可以采用随机行传入来解决
        for (int a : lineTwo) {
            if(pq.size() >= k && a > pq.peek()){
                break;
            }
            for (int b : lineOne) {
                if(pq.size() >= k){
                    if(a + b < pq.peek()){
                        pq.poll();
                        pq.offer(a + b);
                    }
                    continue;
                }
                pq.offer(a + b);
            }
        }

        final int[] result = new int[pq.size()];
        for (int i = result.length - 1; i >= 0; i--) {
            result[i] = pq.poll();
        }
        return result;
    }


    public static void main(String[] args) {
        final Solution1439 demo = new Solution1439();

//        int k = 5;
//        int[][] mat = Common.string2IntIntArr("[[1,3,11],[2,4,6]]");

//        20+case
//        [[13,88,148,211,300,330,399],[71,123,163,229,289,346,357],[45,47,49,75,202,241,283],[45,48,146,231,243,372,400],[40,192,271,279,285,308,368],[128,137,173,221,344,361,368],[67,107,119,281,372,384,396],[2,6,78,102,230,265,355],[2,69,97,134,157,331,392],[77,147,175,213,248,336,355],[7,58,202,275,283,339,366],[74,101,158,162,330,363,371],[78,138,177,177,197,204,379]]
//        50
//        int k = 50;
//        int[][] mat = Common.string2IntIntArr("[[13,88,148,211,300,330,399],[71,123,163,229,289,346,357],[45,47,49,75,202,241,283],[45,48,146,231,243,372,400],[40,192,271,279,285,308,368],[128,137,173,221,344,361,368],[67,107,119,281,372,384,396],[2,6,78,102,230,265,355],[2,69,97,134,157,331,392],[77,147,175,213,248,336,355],[7,58,202,275,283,339,366],[74,101,158,162,330,363,371],[78,138,177,177,197,204,379]]");

//        剪枝后依然超时，40+case
//        [[28,28,63,108,119,173,178,179,187,246,373,440,470,501,551,592,763,832,913],[111,131,148,220,225,255,270,363,428,478,602,633,657,666,682,775,810,906,948],[14,101,263,279,311,313,316,316,393,397,423,483,539,763,772,830,911,963,966],[19,30,163,178,251,257,264,268,531,606,735,820,821,824,828,858,924,986,989],[54,56,149,184,205,274,407,423,489,508,565,582,689,722,826,950,961,987,992],[3,4,52,84,108,241,351,357,370,544,665,679,750,785,813,876,878,881,955],[58,75,85,91,189,324,338,504,518,593,606,663,663,665,722,754,838,842,920],[7,8,53,74,134,137,157,231,296,540,558,559,680,719,757,786,886,925,942],[71,89,108,181,217,545,561,598,604,701,795,828,891,894,909,924,952,959,993],[135,176,185,195,208,217,252,310,324,368,533,572,611,642,650,719,772,926,942],[43,54,63,104,155,204,224,250,336,392,506,536,545,718,732,854,909,947,967],[33,37,239,292,333,356,431,473,478,595,651,657,707,730,763,783,849,881,916],[6,18,21,141,191,197,282,320,361,398,413,461,477,503,541,600,636,681,873],[63,115,156,227,270,297,303,324,493,524,567,703,795,812,899,904,926,928,940],[53,60,75,249,259,344,415,419,421,432,528,662,693,731,738,766,849,872,901],[32,65,137,179,238,243,259,278,302,507,682,707,718,750,757,783,820,841,957],[94,164,166,198,230,255,302,461,585,613,615,628,630,757,773,857,877,984,991],[58,78,84,87,91,262,281,348,367,389,532,533,671,748,791,811,837,977,979],[112,165,281,330,331,519,532,543,548,602,615,673,795,818,851,867,884,908,977],[14,47,58,139,178,182,247,247,414,429,454,461,530,552,618,642,801,830,997],[12,39,105,147,163,229,263,401,456,499,592,616,708,712,744,753,881,888,925],[20,235,264,277,291,367,386,390,482,488,585,605,736,756,872,883,917,923,957]]
//        68
//        answer 1052
//        int k = 68;
//        int[][] mat = Common.string2IntIntArr("[[28,28,63,108,119,173,178,179,187,246,373,440,470,501,551,592,763,832,913],[111,131,148,220,225,255,270,363,428,478,602,633,657,666,682,775,810,906,948],[14,101,263,279,311,313,316,316,393,397,423,483,539,763,772,830,911,963,966],[19,30,163,178,251,257,264,268,531,606,735,820,821,824,828,858,924,986,989],[54,56,149,184,205,274,407,423,489,508,565,582,689,722,826,950,961,987,992],[3,4,52,84,108,241,351,357,370,544,665,679,750,785,813,876,878,881,955],[58,75,85,91,189,324,338,504,518,593,606,663,663,665,722,754,838,842,920],[7,8,53,74,134,137,157,231,296,540,558,559,680,719,757,786,886,925,942],[71,89,108,181,217,545,561,598,604,701,795,828,891,894,909,924,952,959,993],[135,176,185,195,208,217,252,310,324,368,533,572,611,642,650,719,772,926,942],[43,54,63,104,155,204,224,250,336,392,506,536,545,718,732,854,909,947,967],[33,37,239,292,333,356,431,473,478,595,651,657,707,730,763,783,849,881,916],[6,18,21,141,191,197,282,320,361,398,413,461,477,503,541,600,636,681,873],[63,115,156,227,270,297,303,324,493,524,567,703,795,812,899,904,926,928,940],[53,60,75,249,259,344,415,419,421,432,528,662,693,731,738,766,849,872,901],[32,65,137,179,238,243,259,278,302,507,682,707,718,750,757,783,820,841,957],[94,164,166,198,230,255,302,461,585,613,615,628,630,757,773,857,877,984,991],[58,78,84,87,91,262,281,348,367,389,532,533,671,748,791,811,837,977,979],[112,165,281,330,331,519,532,543,548,602,615,673,795,818,851,867,884,908,977],[14,47,58,139,178,182,247,247,414,429,454,461,530,552,618,642,801,830,997],[12,39,105,147,163,229,263,401,456,499,592,616,708,712,744,753,881,888,925],[20,235,264,277,291,367,386,390,482,488,585,605,736,756,872,883,917,923,957]]");

//        调整优先队列后依然超时，61 case
//        [[26,238,542,575,582,629,647,984,1066,1122,1137,1732,2089,2089,2305,2338,2744,2881,2963,3038,3198,3259,3578,3695,3997,4038,4268,4268,4348,4349,4644,4824,4968],[329,560,740,821,831,1092,1156,1193,1634,1808,1899,1907,2407,2442,2446,2977,3147,3168,3170,3248,3703,3746,3773,3798,3913,4210,4396,4480,4696,4743,4748,4852,4930],[5,156,174,315,579,658,882,888,921,1121,1260,1271,1701,2182,2267,2272,2327,2335,2649,2752,2799,2902,3123,3143,3179,3612,3760,3814,3838,4066,4137,4836,4936],[3,11,124,268,378,540,972,1356,1429,1504,1555,1648,1725,1813,1843,1911,1940,2196,2399,2642,2780,2957,3091,3337,3399,3509,3526,3896,4049,4091,4190,4285,4569],[191,330,667,702,1009,1011,1130,1308,1434,1442,1603,1659,1667,1977,2179,2192,2696,2714,2765,2837,3024,3146,3199,3694,3795,3847,3969,4246,4435,4537,4740,4785,4799],[179,283,745,906,910,1023,1051,1070,1078,1125,1321,1359,1623,2075,2100,2489,2717,2909,3188,3281,3451,3621,3641,3642,3744,3792,3937,4203,4322,4699,4851,4881,4986],[63,94,270,312,533,741,1194,1685,2041,2094,2687,2766,2875,2887,2913,2984,3081,3213,3337,3461,3527,3561,3589,3812,3829,3831,3855,3917,3962,3980,4101,4362,4925],[38,69,106,293,389,671,1001,1122,1194,1468,1629,2069,2465,2902,2907,2983,3085,3123,3306,3750,3874,3898,4051,4118,4199,4309,4546,4548,4683,4760,4810,4827,4939],[140,166,168,191,272,348,665,839,1085,1260,1282,1970,2030,2192,2251,2298,2315,2740,2926,3045,3064,3223,3271,3557,3740,3962,4093,4101,4348,4497,4710,4788,4877],[156,649,685,716,838,852,1133,1246,1406,1617,1689,2134,2541,2616,2922,3010,3031,3087,3214,3335,3544,3565,3691,3705,3757,3981,4104,4209,4322,4423,4678,4773,4943],[191,208,389,655,726,890,1222,1319,1651,1761,1762,1790,1835,1969,2224,2369,2460,2677,3151,3166,3500,3570,3625,3689,3923,3969,4146,4202,4443,4517,4558,4756,4993],[130,169,260,346,439,448,619,668,755,769,1026,1061,1430,1532,2202,2485,2545,2684,2861,2884,3424,3568,3645,3720,3761,3771,3843,4138,4259,4406,4413,4639,4962],[14,53,798,817,818,1245,1324,1479,1490,1540,1608,1628,1675,1794,1871,1982,2337,2396,2718,2921,3080,3205,3222,3310,3615,3717,3919,3944,3946,4039,4116,4459,4840],[21,29,128,203,251,858,1116,1139,1303,1342,1370,1812,2014,2148,2180,2376,2380,2714,2736,2802,3058,3227,3271,3275,3282,3817,3862,3932,4226,4592,4647,4822,4907],[144,179,297,496,617,734,753,1109,1145,1153,1455,1586,1710,1791,2036,2102,2109,2204,2405,2464,2867,3116,3345,3379,3511,3617,4038,4062,4082,4143,4215,4763,4864],[7,52,170,177,227,267,435,794,891,910,991,1107,1646,1672,1852,1859,2086,2537,2636,3202,3236,3479,3551,3666,3730,3859,4231,4239,4254,4262,4620,4624,4771],[1,11,205,336,487,575,598,1313,1474,1719,2032,2180,2220,2252,2351,2520,2548,3058,3202,3211,3244,3269,3342,3449,3467,3499,3812,3902,4079,4228,4514,4850,4903],[207,306,335,504,933,989,1005,1129,1207,1444,1528,1669,1700,1751,2097,2330,2336,2498,2580,2611,2627,2825,3138,3195,4078,4082,4112,4254,4276,4505,4774,4843,4973],[8,28,315,425,546,735,1031,1056,1120,1234,1583,1648,1710,1867,1930,2383,2431,2434,2604,2731,2758,2882,3070,3119,3162,3316,3400,3730,4017,4235,4321,4455,4985],[77,1071,1149,1397,1554,1602,1691,1743,1872,1985,2042,2137,2174,2320,2430,2540,2562,2785,2824,2950,3036,3112,3198,3225,3263,3916,4391,4466,4488,4552,4723,4744,4965],[408,782,822,858,910,1071,1138,1516,1584,1644,1671,2017,2059,2427,2626,2747,2851,2875,2895,3213,3377,3409,3459,3467,3561,3887,4223,4252,4341,4347,4430,4701,4845],[71,163,270,318,402,584,685,764,843,852,1003,1038,1040,1421,1534,1718,1843,1910,2235,2370,2498,2682,2825,2892,2910,3016,3473,3791,4283,4309,4447,4782,4931],[41,77,320,379,458,691,715,887,1103,1532,1550,1717,1763,1844,1959,2047,2061,2138,2332,2465,2873,3016,3130,3190,3190,3345,3372,3414,3504,3505,3979,4573,4948],[3,56,168,312,461,488,809,823,835,848,915,1038,1202,1355,1463,1518,1546,1688,1706,1996,2069,2241,2485,2635,2989,3141,3764,4058,4362,4493,4538,4551,4627],[462,483,594,621,1119,1124,1219,1405,1427,1578,1593,1627,1820,2055,2250,2459,2633,2982,3017,3080,3112,3157,3164,3234,3464,3606,3681,3818,3953,4260,4414,4466,4809],[97,236,241,295,510,531,536,742,746,962,986,1616,1660,1667,1686,2037,2153,2196,2475,2728,2811,2969,3090,3241,3504,3528,3626,3744,4157,4198,4478,4517,4543],[103,125,271,342,453,483,772,917,931,1043,1557,1663,1749,1931,2226,2316,2559,2634,2869,2935,3015,3263,3497,3574,3648,3700,3852,3865,3930,4483,4501,4505,4647],[43,67,224,374,518,859,1093,1128,1233,1405,1462,1622,1986,2310,2357,2406,2602,2686,2708,2750,2908,3023,3361,3483,3551,3680,3790,3825,3932,4067,4077,4241,4724],[552,653,861,866,908,1014,1194,1507,1585,1744,1907,1928,2007,2127,2237,2399,2699,2916,3029,3190,3368,3396,3568,3743,3817,3887,4057,4162,4163,4174,4422,4603,4830],[594,601,697,1005,1108,1321,1649,1657,1705,1805,2098,2118,2480,2544,2574,2708,2747,2906,2993,3043,3045,3153,3355,3471,3493,3582,3801,3820,3846,4047,4333,4715,4962],[81,1158,1321,1400,1524,1625,1770,2011,2040,2240,2270,2425,2506,2517,2534,2616,2794,2852,2889,2910,2937,3481,3603,3657,3757,3878,4237,4292,4326,4581,4693,4783,4954],[306,382,388,400,726,754,840,883,1036,1330,1400,1836,2011,2181,2416,2540,2997,3147,3284,3577,3636,3697,3884,4002,4257,4265,4304,4400,4469,4488,4564,4576,4747],[52,72,74,294,404,484,519,648,755,758,762,763,946,1070,1154,1951,1961,2009,2185,2406,2611,2724,2843,2923,3132,3193,3763,3891,4196,4275,4584,4593,4765],[80,220,241,271,282,385,740,756,1025,1216,1265,1292,1353,1360,2177,2654,2767,2954,3090,3100,3122,3309,3327,3410,3958,4069,4108,4133,4134,4183,4228,4500,4925],[94,102,213,663,814,854,1101,1486,1493,1640,1814,1846,2033,2106,2116,2244,2299,2359,2397,2486,2594,2625,2626,3122,3150,3559,3907,3998,4160,4165,4242,4488,4926]]
//        117
//        answer 4954
//        int k = 117;
//        int[][] mat = Common.string2IntIntArr("[[26,238,542,575,582,629,647,984,1066,1122,1137,1732,2089,2089,2305,2338,2744,2881,2963,3038,3198,3259,3578,3695,3997,4038,4268,4268,4348,4349,4644,4824,4968],[329,560,740,821,831,1092,1156,1193,1634,1808,1899,1907,2407,2442,2446,2977,3147,3168,3170,3248,3703,3746,3773,3798,3913,4210,4396,4480,4696,4743,4748,4852,4930],[5,156,174,315,579,658,882,888,921,1121,1260,1271,1701,2182,2267,2272,2327,2335,2649,2752,2799,2902,3123,3143,3179,3612,3760,3814,3838,4066,4137,4836,4936],[3,11,124,268,378,540,972,1356,1429,1504,1555,1648,1725,1813,1843,1911,1940,2196,2399,2642,2780,2957,3091,3337,3399,3509,3526,3896,4049,4091,4190,4285,4569],[191,330,667,702,1009,1011,1130,1308,1434,1442,1603,1659,1667,1977,2179,2192,2696,2714,2765,2837,3024,3146,3199,3694,3795,3847,3969,4246,4435,4537,4740,4785,4799],[179,283,745,906,910,1023,1051,1070,1078,1125,1321,1359,1623,2075,2100,2489,2717,2909,3188,3281,3451,3621,3641,3642,3744,3792,3937,4203,4322,4699,4851,4881,4986],[63,94,270,312,533,741,1194,1685,2041,2094,2687,2766,2875,2887,2913,2984,3081,3213,3337,3461,3527,3561,3589,3812,3829,3831,3855,3917,3962,3980,4101,4362,4925],[38,69,106,293,389,671,1001,1122,1194,1468,1629,2069,2465,2902,2907,2983,3085,3123,3306,3750,3874,3898,4051,4118,4199,4309,4546,4548,4683,4760,4810,4827,4939],[140,166,168,191,272,348,665,839,1085,1260,1282,1970,2030,2192,2251,2298,2315,2740,2926,3045,3064,3223,3271,3557,3740,3962,4093,4101,4348,4497,4710,4788,4877],[156,649,685,716,838,852,1133,1246,1406,1617,1689,2134,2541,2616,2922,3010,3031,3087,3214,3335,3544,3565,3691,3705,3757,3981,4104,4209,4322,4423,4678,4773,4943],[191,208,389,655,726,890,1222,1319,1651,1761,1762,1790,1835,1969,2224,2369,2460,2677,3151,3166,3500,3570,3625,3689,3923,3969,4146,4202,4443,4517,4558,4756,4993],[130,169,260,346,439,448,619,668,755,769,1026,1061,1430,1532,2202,2485,2545,2684,2861,2884,3424,3568,3645,3720,3761,3771,3843,4138,4259,4406,4413,4639,4962],[14,53,798,817,818,1245,1324,1479,1490,1540,1608,1628,1675,1794,1871,1982,2337,2396,2718,2921,3080,3205,3222,3310,3615,3717,3919,3944,3946,4039,4116,4459,4840],[21,29,128,203,251,858,1116,1139,1303,1342,1370,1812,2014,2148,2180,2376,2380,2714,2736,2802,3058,3227,3271,3275,3282,3817,3862,3932,4226,4592,4647,4822,4907],[144,179,297,496,617,734,753,1109,1145,1153,1455,1586,1710,1791,2036,2102,2109,2204,2405,2464,2867,3116,3345,3379,3511,3617,4038,4062,4082,4143,4215,4763,4864],[7,52,170,177,227,267,435,794,891,910,991,1107,1646,1672,1852,1859,2086,2537,2636,3202,3236,3479,3551,3666,3730,3859,4231,4239,4254,4262,4620,4624,4771],[1,11,205,336,487,575,598,1313,1474,1719,2032,2180,2220,2252,2351,2520,2548,3058,3202,3211,3244,3269,3342,3449,3467,3499,3812,3902,4079,4228,4514,4850,4903],[207,306,335,504,933,989,1005,1129,1207,1444,1528,1669,1700,1751,2097,2330,2336,2498,2580,2611,2627,2825,3138,3195,4078,4082,4112,4254,4276,4505,4774,4843,4973],[8,28,315,425,546,735,1031,1056,1120,1234,1583,1648,1710,1867,1930,2383,2431,2434,2604,2731,2758,2882,3070,3119,3162,3316,3400,3730,4017,4235,4321,4455,4985],[77,1071,1149,1397,1554,1602,1691,1743,1872,1985,2042,2137,2174,2320,2430,2540,2562,2785,2824,2950,3036,3112,3198,3225,3263,3916,4391,4466,4488,4552,4723,4744,4965],[408,782,822,858,910,1071,1138,1516,1584,1644,1671,2017,2059,2427,2626,2747,2851,2875,2895,3213,3377,3409,3459,3467,3561,3887,4223,4252,4341,4347,4430,4701,4845],[71,163,270,318,402,584,685,764,843,852,1003,1038,1040,1421,1534,1718,1843,1910,2235,2370,2498,2682,2825,2892,2910,3016,3473,3791,4283,4309,4447,4782,4931],[41,77,320,379,458,691,715,887,1103,1532,1550,1717,1763,1844,1959,2047,2061,2138,2332,2465,2873,3016,3130,3190,3190,3345,3372,3414,3504,3505,3979,4573,4948],[3,56,168,312,461,488,809,823,835,848,915,1038,1202,1355,1463,1518,1546,1688,1706,1996,2069,2241,2485,2635,2989,3141,3764,4058,4362,4493,4538,4551,4627],[462,483,594,621,1119,1124,1219,1405,1427,1578,1593,1627,1820,2055,2250,2459,2633,2982,3017,3080,3112,3157,3164,3234,3464,3606,3681,3818,3953,4260,4414,4466,4809],[97,236,241,295,510,531,536,742,746,962,986,1616,1660,1667,1686,2037,2153,2196,2475,2728,2811,2969,3090,3241,3504,3528,3626,3744,4157,4198,4478,4517,4543],[103,125,271,342,453,483,772,917,931,1043,1557,1663,1749,1931,2226,2316,2559,2634,2869,2935,3015,3263,3497,3574,3648,3700,3852,3865,3930,4483,4501,4505,4647],[43,67,224,374,518,859,1093,1128,1233,1405,1462,1622,1986,2310,2357,2406,2602,2686,2708,2750,2908,3023,3361,3483,3551,3680,3790,3825,3932,4067,4077,4241,4724],[552,653,861,866,908,1014,1194,1507,1585,1744,1907,1928,2007,2127,2237,2399,2699,2916,3029,3190,3368,3396,3568,3743,3817,3887,4057,4162,4163,4174,4422,4603,4830],[594,601,697,1005,1108,1321,1649,1657,1705,1805,2098,2118,2480,2544,2574,2708,2747,2906,2993,3043,3045,3153,3355,3471,3493,3582,3801,3820,3846,4047,4333,4715,4962],[81,1158,1321,1400,1524,1625,1770,2011,2040,2240,2270,2425,2506,2517,2534,2616,2794,2852,2889,2910,2937,3481,3603,3657,3757,3878,4237,4292,4326,4581,4693,4783,4954],[306,382,388,400,726,754,840,883,1036,1330,1400,1836,2011,2181,2416,2540,2997,3147,3284,3577,3636,3697,3884,4002,4257,4265,4304,4400,4469,4488,4564,4576,4747],[52,72,74,294,404,484,519,648,755,758,762,763,946,1070,1154,1951,1961,2009,2185,2406,2611,2724,2843,2923,3132,3193,3763,3891,4196,4275,4584,4593,4765],[80,220,241,271,282,385,740,756,1025,1216,1265,1292,1353,1360,2177,2654,2767,2954,3090,3100,3122,3309,3327,3410,3958,4069,4108,4133,4134,4183,4228,4500,4925],[94,102,213,663,814,854,1101,1486,1493,1640,1814,1846,2033,2106,2116,2244,2299,2359,2397,2486,2594,2625,2626,3122,3150,3559,3907,3998,4160,4165,4242,4488,4926]]");

//        优先队列转为List后依然超时，65case
//        [[121,312,381,415,488,509,536,735,1033,1126,1225,1269,1335,1380,2228,2319,2455,2457,2814,3198,3333,3403,3460,3460,3470,3487,3548,3619,3811,4536,4544,4605,4964],[210,287,452,455,496,538,903,957,1167,1285,1330,1439,1557,1577,1585,2015,2080,2139,2599,2655,2838,2854,3118,3850,3855,4090,4302,4347,4397,4402,4402,4545,4766],[159,227,378,538,553,605,666,705,731,857,1047,1126,1152,1155,1162,1613,1662,1694,1760,1817,2267,2323,2413,2432,2854,3219,3922,3927,4215,4585,4595,4911,4947],[58,596,619,638,806,1285,1294,1687,1691,1737,1758,1784,1810,1838,1983,2022,2222,2451,2614,2617,2982,3032,3246,3426,3780,3863,4030,4049,4080,4107,4180,4513,4517],[91,146,237,290,450,802,810,871,1222,1341,1379,1420,1490,1673,1707,2057,2305,2565,2642,2652,2677,2704,3168,3536,3591,3879,4029,4035,4229,4534,4616,4824,4948],[65,114,122,193,355,554,695,872,1201,1273,1684,1923,2211,2469,2663,2678,2696,2910,3185,3455,3490,3491,3581,3897,4011,4148,4224,4252,4474,4486,4820,4828,4978],[4,481,581,601,917,949,1057,1275,1355,1403,1800,1902,1958,2265,2294,2316,2462,2885,2900,3021,3389,3456,3542,3684,3773,3940,4364,4399,4420,4699,4703,4717,4731],[70,79,222,234,418,514,542,812,861,974,1468,1809,1923,2168,2183,2478,2521,2623,2672,2672,2820,2824,3036,3136,3280,3512,3515,3686,3759,3811,4220,4689,4812],[68,264,797,823,1246,1337,1383,1535,1677,2155,2270,2323,2498,2760,2830,3194,3241,3322,3404,3410,3615,3919,3930,4034,4038,4039,4165,4212,4268,4325,4363,4540,4678],[248,290,306,526,552,770,816,1072,1203,1352,1377,1591,1720,1763,1767,1873,2404,2415,2470,2656,2946,2977,3119,3160,3242,3738,4060,4099,4289,4387,4761,4900,4905],[14,134,308,373,392,422,956,1016,1146,1169,1218,1382,1394,1654,2002,2073,2081,2106,2376,2552,2769,2778,2878,3484,3866,4078,4153,4221,4474,4543,4721,4750,4986],[89,162,213,353,364,435,484,561,1007,1220,1305,1382,1503,1561,1646,1659,1808,1929,2225,2231,2295,2365,2608,2632,2764,2765,3823,3829,4054,4057,4068,4269,4639],[201,541,625,1050,1275,1332,1431,1445,1611,1627,2182,2416,2463,2680,2797,2938,2952,3099,3338,3363,3368,3388,3412,3986,4036,4061,4209,4375,4411,4626,4788,4831,4977],[118,544,655,664,712,804,1066,1837,1846,1930,2079,2137,2166,2242,2448,2531,2661,2740,2752,2924,3032,3154,3221,3518,3867,3935,4003,4008,4116,4264,4295,4373,4722],[26,234,358,387,401,439,455,888,918,922,1079,1196,1198,1322,1858,1962,2126,2223,2644,2876,2902,3417,3560,3565,3713,3719,3720,3760,3881,3955,4198,4668,4794],[11,383,770,855,1170,1170,1318,1325,1383,1654,1722,1833,2007,2199,2478,2559,2642,2674,2815,2869,2938,3110,3304,3376,3444,3616,3812,3859,3874,4197,4232,4483,4727],[137,191,398,777,952,1074,1132,1134,1290,1298,1495,2268,2452,2595,3214,3284,3391,3531,3612,3682,3819,3825,3876,3917,4187,4340,4419,4567,4710,4765,4773,4812,4850],[139,321,498,648,979,1107,1203,1701,1782,2021,2087,2379,2388,2416,2653,2781,3057,3122,3197,3356,3391,3454,3460,3672,3686,4083,4453,4571,4623,4687,4700,4723,4873],[100,324,407,411,414,713,844,949,1086,1169,1294,1360,1543,1705,1906,2117,2290,2419,2700,2882,2889,2978,3011,3145,3370,3686,3723,3738,3793,3974,4042,4416,4660],[84,364,544,638,1530,1690,1959,2051,2156,2448,2622,2651,2691,2748,2795,2935,2998,3375,3438,3477,3486,3496,3646,3845,3896,3991,4056,4186,4327,4394,4663,4768,4886],[75,151,166,298,369,584,927,1087,1585,2151,2253,2380,2559,2566,2838,2996,3006,3243,3245,3404,3446,3516,3751,3976,4119,4258,4366,4443,4469,4576,4646,4754,4848],[33,311,860,938,1118,1180,1482,1519,1587,1706,1742,1798,1854,2251,2337,2360,2383,2596,2613,2640,2696,2961,3100,3197,3956,4025,4075,4102,4137,4171,4324,4970,4986],[5,52,267,418,765,1035,1237,1355,1499,1520,1596,1866,2076,2452,2541,2635,2718,2776,2865,2970,3039,3612,3690,3777,3828,3858,3930,4026,4463,4498,4554,4742,4905],[46,153,328,598,661,1176,1180,1575,1575,1921,2208,2226,2397,2521,2543,2706,2732,2958,3218,3373,3695,3761,3799,3839,3927,4141,4163,4308,4468,4597,4625,4848,4898],[147,295,370,435,871,998,1126,1265,1347,1617,1901,1921,2151,2189,2273,2493,2556,2722,2729,2744,2994,3001,3019,3024,3346,3414,3647,3909,3963,4020,4313,4745,4919],[452,509,536,557,957,1032,1184,1439,1540,1650,1650,1653,1685,1751,1871,1957,2097,2383,2443,2505,2591,2825,3216,3252,3410,3721,3749,3902,3934,4108,4377,4797,4880],[84,98,335,364,564,857,959,974,1201,1325,1436,1479,2124,2222,2684,3077,3243,3252,3275,3411,3686,3822,3875,4073,4113,4118,4305,4360,4387,4439,4642,4735,4865],[8,506,789,1098,1127,1250,1260,1591,1597,1599,1743,1809,1874,2316,2336,2394,2547,3215,3314,3342,3591,3629,3813,4090,4154,4234,4356,4551,4658,4679,4829,4864,4936],[242,472,515,634,1031,1047,1347,1475,1566,1764,2040,2177,2470,2706,2807,2893,2904,2940,3039,3353,3377,3453,3470,3606,3622,3834,4197,4202,4423,4474,4511,4846,4964],[579,941,980,1015,1054,1471,1495,1699,2019,2036,2250,2477,2525,2649,2653,2691,2726,2734,2827,2898,3039,3531,3786,3921,3952,4515,4527,4571,4599,4609,4617,4703,4794],[91,181,376,400,494,956,1023,1041,1231,1451,1514,1632,1894,2076,2440,2469,2960,3222,3371,3453,3571,3577,3881,4058,4195,4215,4377,4412,4460,4463,4551,4864,4931],[67,305,375,497,564,660,795,812,1333,1458,1802,2011,2026,2077,2092,2191,2210,2287,2322,2356,2378,3193,3342,3553,3778,3797,3845,3873,4009,4061,4315,4336,4905],[135,136,399,442,599,601,776,852,990,1032,1117,1251,1260,1478,1573,2011,2079,2567,2640,2643,2679,2766,2923,3065,3380,4048,4114,4221,4240,4492,4621,4717,4903],[13,101,164,705,985,995,1083,1162,1241,1327,1357,1433,1454,1457,1503,1540,1618,1698,1844,1894,1906,1986,2556,3064,3348,3433,3539,4326,4333,4626,4659,4734,4983]]
//        129
//        answer 4089
        int k = 129;
        int[][] mat = Common.string2IntIntArr("[[121,312,381,415,488,509,536,735,1033,1126,1225,1269,1335,1380,2228,2319,2455,2457,2814,3198,3333,3403,3460,3460,3470,3487,3548,3619,3811,4536,4544,4605,4964],[210,287,452,455,496,538,903,957,1167,1285,1330,1439,1557,1577,1585,2015,2080,2139,2599,2655,2838,2854,3118,3850,3855,4090,4302,4347,4397,4402,4402,4545,4766],[159,227,378,538,553,605,666,705,731,857,1047,1126,1152,1155,1162,1613,1662,1694,1760,1817,2267,2323,2413,2432,2854,3219,3922,3927,4215,4585,4595,4911,4947],[58,596,619,638,806,1285,1294,1687,1691,1737,1758,1784,1810,1838,1983,2022,2222,2451,2614,2617,2982,3032,3246,3426,3780,3863,4030,4049,4080,4107,4180,4513,4517],[91,146,237,290,450,802,810,871,1222,1341,1379,1420,1490,1673,1707,2057,2305,2565,2642,2652,2677,2704,3168,3536,3591,3879,4029,4035,4229,4534,4616,4824,4948],[65,114,122,193,355,554,695,872,1201,1273,1684,1923,2211,2469,2663,2678,2696,2910,3185,3455,3490,3491,3581,3897,4011,4148,4224,4252,4474,4486,4820,4828,4978],[4,481,581,601,917,949,1057,1275,1355,1403,1800,1902,1958,2265,2294,2316,2462,2885,2900,3021,3389,3456,3542,3684,3773,3940,4364,4399,4420,4699,4703,4717,4731],[70,79,222,234,418,514,542,812,861,974,1468,1809,1923,2168,2183,2478,2521,2623,2672,2672,2820,2824,3036,3136,3280,3512,3515,3686,3759,3811,4220,4689,4812],[68,264,797,823,1246,1337,1383,1535,1677,2155,2270,2323,2498,2760,2830,3194,3241,3322,3404,3410,3615,3919,3930,4034,4038,4039,4165,4212,4268,4325,4363,4540,4678],[248,290,306,526,552,770,816,1072,1203,1352,1377,1591,1720,1763,1767,1873,2404,2415,2470,2656,2946,2977,3119,3160,3242,3738,4060,4099,4289,4387,4761,4900,4905],[14,134,308,373,392,422,956,1016,1146,1169,1218,1382,1394,1654,2002,2073,2081,2106,2376,2552,2769,2778,2878,3484,3866,4078,4153,4221,4474,4543,4721,4750,4986],[89,162,213,353,364,435,484,561,1007,1220,1305,1382,1503,1561,1646,1659,1808,1929,2225,2231,2295,2365,2608,2632,2764,2765,3823,3829,4054,4057,4068,4269,4639],[201,541,625,1050,1275,1332,1431,1445,1611,1627,2182,2416,2463,2680,2797,2938,2952,3099,3338,3363,3368,3388,3412,3986,4036,4061,4209,4375,4411,4626,4788,4831,4977],[118,544,655,664,712,804,1066,1837,1846,1930,2079,2137,2166,2242,2448,2531,2661,2740,2752,2924,3032,3154,3221,3518,3867,3935,4003,4008,4116,4264,4295,4373,4722],[26,234,358,387,401,439,455,888,918,922,1079,1196,1198,1322,1858,1962,2126,2223,2644,2876,2902,3417,3560,3565,3713,3719,3720,3760,3881,3955,4198,4668,4794],[11,383,770,855,1170,1170,1318,1325,1383,1654,1722,1833,2007,2199,2478,2559,2642,2674,2815,2869,2938,3110,3304,3376,3444,3616,3812,3859,3874,4197,4232,4483,4727],[137,191,398,777,952,1074,1132,1134,1290,1298,1495,2268,2452,2595,3214,3284,3391,3531,3612,3682,3819,3825,3876,3917,4187,4340,4419,4567,4710,4765,4773,4812,4850],[139,321,498,648,979,1107,1203,1701,1782,2021,2087,2379,2388,2416,2653,2781,3057,3122,3197,3356,3391,3454,3460,3672,3686,4083,4453,4571,4623,4687,4700,4723,4873],[100,324,407,411,414,713,844,949,1086,1169,1294,1360,1543,1705,1906,2117,2290,2419,2700,2882,2889,2978,3011,3145,3370,3686,3723,3738,3793,3974,4042,4416,4660],[84,364,544,638,1530,1690,1959,2051,2156,2448,2622,2651,2691,2748,2795,2935,2998,3375,3438,3477,3486,3496,3646,3845,3896,3991,4056,4186,4327,4394,4663,4768,4886],[75,151,166,298,369,584,927,1087,1585,2151,2253,2380,2559,2566,2838,2996,3006,3243,3245,3404,3446,3516,3751,3976,4119,4258,4366,4443,4469,4576,4646,4754,4848],[33,311,860,938,1118,1180,1482,1519,1587,1706,1742,1798,1854,2251,2337,2360,2383,2596,2613,2640,2696,2961,3100,3197,3956,4025,4075,4102,4137,4171,4324,4970,4986],[5,52,267,418,765,1035,1237,1355,1499,1520,1596,1866,2076,2452,2541,2635,2718,2776,2865,2970,3039,3612,3690,3777,3828,3858,3930,4026,4463,4498,4554,4742,4905],[46,153,328,598,661,1176,1180,1575,1575,1921,2208,2226,2397,2521,2543,2706,2732,2958,3218,3373,3695,3761,3799,3839,3927,4141,4163,4308,4468,4597,4625,4848,4898],[147,295,370,435,871,998,1126,1265,1347,1617,1901,1921,2151,2189,2273,2493,2556,2722,2729,2744,2994,3001,3019,3024,3346,3414,3647,3909,3963,4020,4313,4745,4919],[452,509,536,557,957,1032,1184,1439,1540,1650,1650,1653,1685,1751,1871,1957,2097,2383,2443,2505,2591,2825,3216,3252,3410,3721,3749,3902,3934,4108,4377,4797,4880],[84,98,335,364,564,857,959,974,1201,1325,1436,1479,2124,2222,2684,3077,3243,3252,3275,3411,3686,3822,3875,4073,4113,4118,4305,4360,4387,4439,4642,4735,4865],[8,506,789,1098,1127,1250,1260,1591,1597,1599,1743,1809,1874,2316,2336,2394,2547,3215,3314,3342,3591,3629,3813,4090,4154,4234,4356,4551,4658,4679,4829,4864,4936],[242,472,515,634,1031,1047,1347,1475,1566,1764,2040,2177,2470,2706,2807,2893,2904,2940,3039,3353,3377,3453,3470,3606,3622,3834,4197,4202,4423,4474,4511,4846,4964],[579,941,980,1015,1054,1471,1495,1699,2019,2036,2250,2477,2525,2649,2653,2691,2726,2734,2827,2898,3039,3531,3786,3921,3952,4515,4527,4571,4599,4609,4617,4703,4794],[91,181,376,400,494,956,1023,1041,1231,1451,1514,1632,1894,2076,2440,2469,2960,3222,3371,3453,3571,3577,3881,4058,4195,4215,4377,4412,4460,4463,4551,4864,4931],[67,305,375,497,564,660,795,812,1333,1458,1802,2011,2026,2077,2092,2191,2210,2287,2322,2356,2378,3193,3342,3553,3778,3797,3845,3873,4009,4061,4315,4336,4905],[135,136,399,442,599,601,776,852,990,1032,1117,1251,1260,1478,1573,2011,2079,2567,2640,2643,2679,2766,2923,3065,3380,4048,4114,4221,4240,4492,4621,4717,4903],[13,101,164,705,985,995,1083,1162,1241,1327,1357,1433,1454,1457,1503,1540,1618,1698,1844,1894,1906,1986,2556,3064,3348,3433,3539,4326,4333,4626,4659,4734,4983]]");

        final long begin = System.nanoTime();
        System.out.println(demo.kthSmallest1(mat, k));
        System.out.println((System.nanoTime() - begin) / Math.pow(10, 9) + " s");
    }
}
